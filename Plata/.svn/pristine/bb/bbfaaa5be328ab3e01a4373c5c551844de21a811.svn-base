LPARAMETERS tcSENHA, tcSEMENTE
* SEMENTE É PARAMETRO OPCIONAL C(1)
* OBS: não existe rotina reversa de decriptação, o que garante o sigilo da senha

IF TYPE('tcSEMENTE')<>'C'
	tcSEMENTE = ' '
ENDIF
tcSENHA = ALLTRIM(tcSENHA)

LOCAL lcLETRA, lcCRIPTA AS STRING
LOCAL lcMACRO AS Variant

IF RETORNASET('USUARIOS.EXTERNO','C',1)='ON'
	* OPÇÃO DE ROTINA EXTERNA (SYS_FUNCOES) DE VALIDACAO
	lcMACRO = "lcCRIPTA = CRIPTAREXTERNO(tcSENHA)"
	&lcMACRO
	RETURN(lcCRIPTA)
ENDIF

IF EMPTY(tcSEMENTE)
	* VALIDA TIPO DE CRIPTOGRAFIA DE SENHA
	IF RETORNASET('SENHA.CRIPTARHASH','C',1) = 'ON'
		tcSEMENTE = '+'
	ELSE
		lnSEMENTE = INT(25*RAND(SECONDS()*100))
		tcSEMENTE = CHR(64+lnSEMENTE)
	ENDIF
ENDIF

lcCRIPTA = tcSEMENTE

IF tcSEMENTE = '+'
	* NOVA FORMA DE CRIPTOGRAFIA DE SENHAS UTILIZANDO MD5
	lcCRIPTA = lcCRIPTA + HASHMD5(tcSENHA)
ELSE

	lnRESTO = MOD(ASC(tcSEMENTE),10)+1

	LOCAL lnI, lnASC AS INTEGER
	FOR lnI = 1 TO 30
		lcLETRA = SUBSTR(tcSENHA,lnI,1)
		lnASC = ASC(lcLETRA)
		lnASC = lnASC + lnI + lnRESTO
		lcJUNTA = CHR( MOD(lnASC,220)+14 )
		IF lcJUNTA=CHR(39)
			lcJUNTA=CHR(5)
		ENDIF
		lnRESTO = MOD(lnASC,32)+1
		lcCRIPTA = lcCRIPTA + lcJUNTA
	ENDFOR
ENDIF

RETURN(lcCRIPTA)